# Парсер Вконтакте

Парсер для поиска постов и комментариев в группах по ключевым словам

  - Ищет комментарии в обсуждениях групп
  - Ищет комментарии в записях на стене
  - Ищет записи на стене
  - Может отправлять результаты на почту или в таблицу на гугл диске

### Установка
Склонируйте репозиторий, зайтите в рабочую папку, установите нужные гемы.

```sh
$ git clone git@github.com:fixel92/ruby-vk-parser.git
$ cd ruby-vk-parser
$ bundle install
```
### Настройка
Перед запуском парсера, Вам необходимо подготовиться.
##### Для работы Вам нужен
  - Сервисный токен.
  - Список групп для парсинга
  - Список ключевых слов
  - Список Анти-ключевых слов
  - Почта для отправки результата *
  - Почта для приема результата *
  - Настройка и сервисный токен к гугл-диску *
  
*Можно не использовать почту или гугл диск и получать результат в виде файла txt или html.

#### Получаем сервисный токен Вконтакте
https://vk.com/apps?act=manage - переходим по этой ссылке  и нажимаем **создать приложение**.

![alt text](https://i.ibb.co/G9TS691/2020-01-30-09-22-50.png)

Во вкладке **Настройки** скопируйте сервисный ключ доступа. Без него не получится использовать методы API для получения постов, комментариев и обсуждений.

![alt text](https://i.ibb.co/8NFmDDF/2020-01-30-09-26-19.png)
  
Теперь вставляем полученый сервисный ключ в созданный файл ```.env``` . Пример его содержимого Вы найдете в файле ```.env.sample ```

Файл ```.env.sample```

| Переменная | Значение |
| ------ | ------ |
| EMAIL_TO | Почта на которую будут отправляться результаты |
| EMAIL_FROM | Почта с которой мы будем отправлять результаты(используем SMTP) |
| EMAIL_FROM_PASSWORD | Пароль от почты отправителя |
| SERVICE_TOKEN_VK | Сервисный ключ доступа |
| GOOGLE_CLIENT_ID | ID клиента Google API |
| GOOGLE_CLIENT_SECRET | Секретный ключ Google API |
| GMAIL | Почта гугл диска на котором хранятся файлы |

#### Заполняем ключевые слова и ссылки на группы

В папке ``` data ```

| Файл | Назначение |
| ------ | ------ |
| input_data.csv | CSV файл с разделителем ",". Содержит урлы, ключевые, антиключевые слова и фразы. |
| data.db | База данных Sqlite3, которая хранит уже найденные ранее записи. |

В файле ``` input_data.csv ```
| Колонка | Назначение |
| ------ | ------ |
| urls | Список ссылкок на группы в формате ***https://vk.com/batumihelp*** (Группы должны быть с открытой стеной) |
| keywords | Ключевые слова. Парсер ищет записи по этим ключам. Вы можете указывать не только слова, но и фразы. |
| anti_keywords | Анти-ключевые слова. Отсеивают записи по не нужным ключам. Вы можете указывать не только слова, но и фразы.  |

Внесите свои данные во входной файл input_data.csv.
Обратите внимание, что Вам, возможно, придется редактировать и дополнять как ключевые так и антиключевые слова, до тех пор пока Вы не настроите поиск на нужные Вам результаты.

#### Настройка почты
Создайте новую почту gmail. ***НЕ ИСПОЛЬЗУЙТЕ ЛИЧНУЮ ПОЧТУ!!!***
Если Вы хотите получать результаты на почту, тогда Вам нужно настроить почту (я использую gmail) для работы по протоколу SMTP. https://support.google.com/mail/answer/7126229?hl=ru

Кроме этого на странице https://myaccount.google.com/security разрешите доступ ненадежным приложениям.
**Будьте внимательны! Проверьте, что почта совпадает с аккаунтом!!!**

Первое письмо отправленное таким образом, гугл может не отправить. Но пришлет Вам письмо с вопросом, Вы ли пытались подключиться к сервису? Соглашаетесь и теперь результаты парсинга будут приходить на указанную почту в ```.env``` файле.

### Типы вывода результатов
| Флаг | Назначение |
| ------ | ------ |
=======
| email | Отправляет письмо с результатами (**требуется предварительная настройка**)  |
| txt | Создает файл my_output.txt с результатами |
| html | Создает файл my_output.html с результатами |
| json | Создает файл my_output.json с результатами |
| google_csv | Создает googlesheet файл(ruby_vk_parser_csv) на гугл-диске в папке ruby-vk-parser (**требуется предварительная настройка**) |
| online_table | Создает html страницу и отправляет на гугл диск. Эта страница доступна онлайн через сервис **drv.tw** (**требуется предварительная настройка**) |

Если вывод на почту или гугл-диске не нужен, выбирайте вывод в html. Открыв файл в браузере вы нажимая на ссылки сразу будете попадать на запись или комментарий.

### Запуск
=======
Указываем флаги для получения нужного формата. Если флаги(--input, --output) не будут указаны, по умолчанию берет информацию из csv файла **data/input_data.csv** и создает файл выходной файл **my_output.html** с результатами. По умолчаюнию ищутся посты и комментарии не старше 14 дней от текущей даты. Это значение можно менять используя флаг **--days_ago [за какое количество дней искать записи]**
```sh
$ ruby app.rb --input[csv] --output[email|html|txt|json|google_csv|online_table] --days_ago[1-180]
```

### Результат
Вывод на почту

![alt text](https://i.ibb.co/gwRNrZV/2020-01-30-11-02-30.png)

Вывод в html страницу

![alt text](https://i.ibb.co/4NwkTVP/2020-01-30-11-15-28.png)

Вывод в txt файл

![alt text](https://i.ibb.co/d4bLCGY/2020-01-30-11-33-18.png)


### Todos

 - Поиск комментариев под фото
 - Переписать запросы к API и ускорить поиск через execute
 - Вывод в телеграм
 - Получение ключевых слов из Google  Sheets 

License
----

MIT

**Free Software, Hell Yeah!**
### Thanks
**Thanks to https://dillinger.io/ for README**
